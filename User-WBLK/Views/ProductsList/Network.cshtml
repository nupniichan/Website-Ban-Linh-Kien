@model ProductListViewModel
@{
    ViewData["Title"] = "Thiết bị mạng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mx-auto px-4">
    <!-- Categories -->
    <div class="bg-white rounded-lg p-4">
        <h2 class="font-semibold mb-2">Danh mục:</h2>
        <div class="flex flex-wrap gap-2">
            <a href="@Url.Action("Network", new { category = "router" })" 
               class="px-4 py-2 bg-gray-100 rounded-md hover:bg-gray-200 @(Model?.Category == "router" ? "bg-blue-600 text-white" : "")">
                Router
            </a>
            <a href="@Url.Action("Network", new { category = "switch" })"
               class="px-4 py-2 bg-gray-100 rounded-md hover:bg-gray-200 @(Model?.Category == "switch" ? "bg-blue-600 text-white" : "")">
                Switch
            </a>
            <a href="@Url.Action("Network", new { category = "lan-card" })"
               class="px-4 py-2 bg-gray-100 rounded-md hover:bg-gray-200 @(Model?.Category == "lan-card" ? "bg-blue-600 text-white" : "")">
                Card mạng
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg p-4">
        <h2 class="font-semibold mb-2">Bộ lọc:</h2>
        @switch (Model?.Category?.ToLower())
        {
            case "router":
                <div class="space-y-4">
                    <div class="flex flex-wrap gap-2">
                        <select id="brand" class="px-4 py-2 border rounded-md w-48" onchange="updateFilters(this)">
                            <option value="">Tất cả thương hiệu</option>
                            @foreach (var brand in new[] { "tp-link", "tenda", "asus", "linksys" })
                            {
                                <option value="@brand" selected="@(Model?.Brand == brand)">
                                    @(brand.ToUpper())
                                </option>
                            }
                        </select>

                        <select id="type" class="px-4 py-2 border rounded-md w-48" onchange="updateFilters(this)">
                            <option value="">Tất cả loại</option>
                            @foreach (var type in new[] { 
                                new { value = "wifi-6", text = "Wifi 6" },
                                new { value = "wifi-5", text = "Wifi 5" },
                                new { value = "4g", text = "4G" }
                            })
                            {
                                <option value="@type.value" 
                                        selected="@(Model?.AdditionalFilters?.GetValueOrDefault("type") == type.value)">
                                    @type.text
                                </option>
                            }
                        </select>
                    </div>
                </div>
                break;

            case "switch":
                <div class="space-y-4">
                    <div class="flex flex-wrap gap-2">
                        <select id="brand" class="px-4 py-2 border rounded-md">
                            @{
                                var switchBrands = new[] {
                                    new { Value = "", Text = "Tất cả thương hiệu" },
                                    new { Value = "tp-link", Text = "TP-Link" },
                                    new { Value = "cisco", Text = "Cisco" },
                                    new { Value = "d-link", Text = "D-Link" },
                                    new { Value = "netgear", Text = "NETGEAR" }
                                };
                            }
                            @foreach (var brand in switchBrands)
                            {
                                <option value="@brand.Value" selected="@(Model?.Brand == brand.Value)">@brand.Text</option>
                            }
                        </select>

                        <select id="type" class="px-4 py-2 border rounded-md">
                            @{
                                var switchTypes = new[] {
                                    new { Value = "", Text = "Tất cả loại" },
                                    new { Value = "unmanaged", Text = "Unmanaged" },
                                    new { Value = "managed", Text = "Managed" },
                                    new { Value = "smart", Text = "Smart" }
                                };
                            }
                            @foreach (var type in switchTypes)
                            {
                                <option value="@type.Value" selected="@(Model?.AdditionalFilters?.ContainsKey("type") == true && Model.AdditionalFilters["type"] == type.Value)">@type.Text</option>
                            }
                        </select>
                    </div>
                </div>
                break;

            case "lan-card":
                <div class="space-y-4">
                    <div class="flex flex-wrap gap-2">
                        <select id="brand" class="px-4 py-2 border rounded-md w-48" onchange="updateFilters(this)">
                            <option value="">Tất cả thương hiệu</option>
                            @foreach (var brand in new[] { "tp-link", "intel", "asus" })
                            {
                                <option value="@brand" selected="@(Model?.Brand == brand)">
                                    @(brand.ToUpper())
                                </option>
                            }
                        </select>

                        <select id="connection" class="px-4 py-2 border rounded-md w-48" onchange="updateFilters(this)">
                            <option value="">Tất cả kết nối</option>
                            @foreach (var conn in new[] { 
                                new { value = "pci-e", text = "PCI-E" },
                                new { value = "usb", text = "USB" }
                            })
                            {
                                <option value="@conn.value" 
                                        selected="@(Model?.AdditionalFilters?.GetValueOrDefault("connection") == conn.value)">
                                    @conn.text
                                </option>
                            }
                        </select>
                    </div>
                </div>
                break;

            default:
                <div class="text-gray-500">Vui lòng chọn danh mục để xem các bộ lọc chi tiết</div>
                break;
        }
    </div>

    <!-- Price Range -->
    <div class="bg-white rounded-lg p-4 mb-6">
        <h2 class="font-semibold mb-2">Khoảng giá:</h2>
        <div class="flex flex-wrap gap-2">
            <a href="@Url.Action("Network", new { category = Model?.Category, priceRange = "duoi-500-nghin" })"
               class="px-4 py-2 bg-gray-100 rounded-md hover:bg-gray-200 @(Model?.PriceRange == "duoi-500-nghin" ? "bg-blue-600 text-white" : "")">
                Dưới 500 nghìn
            </a>
            <a href="@Url.Action("Network", new { category = Model?.Category, priceRange = "500-1-trieu" })"
               class="px-4 py-2 bg-gray-100 rounded-md hover:bg-gray-200 @(Model?.PriceRange == "500-1-trieu" ? "bg-blue-600 text-white" : "")">
                500 nghìn - 1 triệu
            </a>
            <a href="@Url.Action("Network", new { category = Model?.Category, priceRange = "1-2-trieu" })"
               class="px-4 py-2 bg-gray-100 rounded-md hover:bg-gray-200 @(Model?.PriceRange == "1-2-trieu" ? "bg-blue-600 text-white" : "")">
                1 - 2 triệu
            </a>
            <a href="@Url.Action("Network", new { category = Model?.Category, priceRange = "2-5-trieu" })"
               class="px-4 py-2 bg-gray-100 rounded-md hover:bg-gray-200 @(Model?.PriceRange == "2-5-trieu" ? "bg-blue-600 text-white" : "")">
                2 - 5 triệu
            </a>
            <a href="@Url.Action("Network", new { category = Model?.Category, priceRange = "tren-5-trieu" })"
               class="px-4 py-2 bg-gray-100 rounded-md hover:bg-gray-200 @(Model?.PriceRange == "tren-5-trieu" ? "bg-blue-600 text-white" : "")">
                Trên 5 triệu
            </a>
        </div>
    </div>

    <!-- Products Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 mt-6">
        @if (Model.Products != null && Model.Products.Any())
        {
            var allProducts = Model.Products.ToList();
            
            for (int i = 0; i < allProducts.Count; i++)
            {
                var product = allProducts[i];
                var isHidden = i >= 10;
                
                <div class="product-item @(isHidden ? "hidden" : "")" data-index="@i">
                    <partial name="_ProductCard" model='new ProductCardViewModel 
                    { 
                        IdSp = product.IdSp,
                        TenSp = product.Tensanpham,
                        Gia = product.Gia,
                        ImageUrl = product.Hinhanh,
                        LoaiSp = "network"
                    }' />
                </div>
            }
        }
        else
        {
            <div class="col-span-full text-center py-8 text-gray-500">
                Không tìm thấy sản phẩm nào phù hợp với tiêu chí tìm kiếm
            </div>
        }
    </div>

    @if (Model.Products != null && Model.Products.Count() > 10)
    {
        <div class="text-center mt-6">
            <button id="loadMoreBtn" class="bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600 transition-colors duration-300">
                Xem thêm
            </button>
            <button id="collapseBtn" class="hidden bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 transition-colors duration-300 ml-2">
                Thu gọn
            </button>
        </div>
    }
</div>

@section Scripts {
    <script>
        function updateFilters(selectElement) {
            const params = new URLSearchParams(window.location.search);
            
            const category = '@Model?.Category';
            const priceRange = '@Model?.PriceRange';
            
            for (let param of params.keys()) {
                params.delete(param);
            }
            
            if (category) params.set('category', category);
            if (priceRange) params.set('priceRange', priceRange);
            
            document.querySelectorAll('select').forEach(select => {
                if (select.value) {
                    params.set(select.id, select.value);
                }
            });
            
            window.location.href = `${window.location.pathname}?${params.toString()}`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const collapseBtn = document.getElementById('collapseBtn');
            const products = document.querySelectorAll('.product-item');
            const productsPerPage = 10;
            let currentlyShown = productsPerPage;

            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', function() {
                    // Calculate next batch of products to show
                    const nextBatch = Array.from(products)
                        .slice(currentlyShown, currentlyShown + productsPerPage);
                    
                    // Show next batch of products
                    nextBatch.forEach(product => {
                        product.classList.remove('hidden');
                    });

                    // Update counter
                    currentlyShown += productsPerPage;

                    // Hide "Xem thêm" button and show "Thu gọn" button if we've shown all products
                    if (currentlyShown >= products.length) {
                        loadMoreBtn.classList.add('hidden');
                        collapseBtn.classList.remove('hidden');
                    }
                });
            }

            if (collapseBtn) {
                collapseBtn.addEventListener('click', function() {
                    // Hide all products after the first 10
                    Array.from(products).forEach((product, index) => {
                        if (index >= productsPerPage) {
                            product.classList.add('hidden');
                        }
                    });

                    // Reset counter
                    currentlyShown = productsPerPage;

                    // Show "Xem thêm" button and hide "Thu gọn" button
                    loadMoreBtn.classList.remove('hidden');
                    collapseBtn.classList.add('hidden');

                    // Scroll back to the top of the products section
                    products[0].scrollIntoView({ behavior: 'smooth' });
                });
            }
        });
    </script>
}

