@model PaginatedList<Website_Ban_Linh_Kien.Models.Donhang>

@{
    ViewBag.Title = "OrderHistory";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="flex flex-col">
    <!-- Space below navbar -->
    <div class="h-16"></div>
    <div class="flex gap-6">
        <!-- Sidebar -->
        <partial name="_AccountSidebar" />

        <!-- Main Content -->
        <div class="flex-1 bg-white shadow-lg rounded-lg p-6">
            @if(ViewBag.DetailOrder != null)
            {
                // Detail Mode: show full order details
                var order = (Website_Ban_Linh_Kien.Models.Donhang)ViewBag.DetailOrder;
                <h1 class="text-2xl font-bold mb-6">Chi tiết đơn hàng: @order.IdDh</h1>
                <div class="mb-4">
                    <p><strong>Ngày đặt:</strong> @order.Ngaydathang?.ToString("dd/MM/yyyy hh:mm tt")</p>
                    <p><strong>Tổng tiền:</strong> @order.Tongtien.ToString("N0") VNĐ</p>
                    <p><strong>Trạng thái:</strong> @order.Trangthai</p>
                    <p><strong>Địa chỉ giao hàng:</strong> @order.Diachigiaohang</p>
                    <p><strong>Phương thức thanh toán:</strong> @order.Phuongthucthanhtoan</p>
                    @if(!string.IsNullOrEmpty(order.Ghichu))
                    {
                        <p><strong>Ghi chú:</strong> @order.Ghichu</p>
                    }
                </div>
                <div class="mb-4">
                    <h2 class="text-xl font-bold mb-2">Chi tiết sản phẩm</h2>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sản phẩm</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Đơn giá</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số lượng</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            @foreach(var item in order.Chitietdonhangs)
                            {
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">@item.IdSpNavigation.Tensanpham</td>
                                    <td class="px-6 py-4 whitespace-nowrap">@item.Dongia.ToString("N0") VNĐ</td>
                                    <td class="px-6 py-4 whitespace-nowrap">@item.Soluongsanpham</td>
                                    <td class="px-6 py-4 whitespace-nowrap">@((item.Dongia * item.Soluongsanpham).ToString("N0")) VNĐ</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                @* Badge based on order status, matching only the provided list *@
                <div>
                    @if(order.Trangthai == "Chờ xác nhận")
                    {
                        <span class="bg-yellow-100 text-yellow-700 text-sm font-medium px-3 py-1 rounded-full">Chờ xác nhận</span>
                    }
                    else if(order.Trangthai == "Đã thanh toán")
                    {
                        <span class="bg-green-100 text-green-500 text-sm font-medium px-3 py-1 rounded-full">Đã thanh toán</span>
                    }
                    else if(order.Trangthai == "Đặt hàng thành công")
                    {
                        <span class="bg-blue-100 text-blue-700 text-sm font-medium px-3 py-1 rounded-full">Đặt hàng thành công</span>
                    }
                    else if(order.Trangthai == "Đã duyệt đơn")
                    {
                        <span class="bg-indigo-100 text-indigo-700 text-sm font-medium px-3 py-1 rounded-full">Đã duyệt đơn</span>
                    }
                    else if(order.Trangthai == "Đang giao")
                    {
                        <span class="bg-green-100 text-green-700 text-sm font-medium px-3 py-1 rounded-full">Đang giao</span>
                    }
                    else if(order.Trangthai == "Giao thành công")
                    {
                        <span class="bg-blue-500 text-white text-sm font-medium px-3 py-1 rounded-full">Giao thành công</span>
                    }
                    else if(order.Trangthai == "Không giao")
                    {
                        <span class="bg-orange-100 text-orange-700 text-sm font-medium px-3 py-1 rounded-full">Không giao</span>
                    }
                    else if(order.Trangthai == "Hủy đơn")
                    {
                        <span class="bg-gray-100 text-gray-700 text-sm font-medium px-3 py-1 rounded-full">Hủy đơn</span>
                    }
                </div>
                @* "Đánh giá" button appears if the order is "Giao thành công" and not reviewed *@
                @if(order.Trangthai == "Giao thành công" && order.Chitietdonhangs.All(ct => ct.IdDg != null) == false)
                {
                    <div class="mt-6 text-right">
                        <button id="openReviewModal" class="bg-blue-500 text-white px-4 py-2 rounded-md font-medium shadow hover:bg-blue-600">
                            Đánh giá
                        </button>
                    </div>
                }
                @* "Hủy đơn" button appears if the order is in "Chờ xác nhận" or "Đã duyệt đơn" status *@
                @if(order.Trangthai == "Chờ xác nhận" || order.Trangthai == "Đã duyệt đơn")
                {
                    <div class="mt-6 text-right">
                        <form id="cancelOrderForm" method="post" asp-action="CancelOrder">
                            <input type="hidden" name="orderId" value="@order.IdDh" />
                            <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-md font-medium shadow hover:bg-red-600">
                                Hủy đơn
                            </button>
                        </form>
                    </div>
                }
                <div class="mt-6 text-right">
                    <!-- "Đóng" returns to the order list -->
                    <a asp-action="OrderHistory" class="bg-gray-500 text-white px-6 py-2 rounded-lg font-medium shadow hover:bg-gray-600">
                        Đóng
                    </a>
                </div>

                @* Modal Popup for Submitting a Review (inside the detail block) *@
                <div id="reviewModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
                    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                        <h2 class="text-xl font-bold mb-4">Đánh giá đơn hàng</h2>
                        <form id="reviewForm" method="post" asp-action="SubmitReview">
                            @* Use the first order detail that has not yet been reviewed *@
                            @{
                                var firstUnreviewedItem = order.Chitietdonhangs.FirstOrDefault(ct => ct.IdDg == null);
                            }
                            @if (firstUnreviewedItem != null)
                            {
                                <input type="hidden" name="Idchitietdonhang" value="@firstUnreviewedItem.Idchitietdonhang" />
                            }
                            else
                            {
                                <p>Tất cả sản phẩm trong đơn hàng này đã được đánh giá.</p>
                            }

                            <div class="mb-4">
                                <label class="block text-gray-700">Đánh giá:</label>
                                <select name="rating" class="mt-1 block w-full">
                                    <option value="1">1 sao</option>
                                    <option value="2">2 sao</option>
                                    <option value="3">3 sao</option>
                                    <option value="4">4 sao</option>
                                    <option value="5">5 sao</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700">Bình luận:</label>
                                <textarea name="comment" class="mt-1 block w-full" rows="3"></textarea>
                            </div>
                            <div class="flex justify-end">
                                <button type="button" id="closeReviewModal" class="bg-gray-500 text-white px-4 py-2 rounded-md mr-2">Đóng</button>
                                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md">Gửi đánh giá</button>
                            </div>
                        </form>
                    </div>
                </div>
            }
            else
            {
                // List Mode: show paginated order history list
                <h1 class="text-2xl font-bold mb-6">Lịch sử giao dịch</h1>
                <div class="space-y-4">
                    @if(Model.Items == null || !Model.Items.Any())
                    {
                        <p class="text-gray-500">Không có đơn hàng nào.</p>
                    }
                    else
                    {
                        @foreach(var order in Model.Items)
                        {
                            <div class="bg-gray-50 p-4 rounded-lg shadow-md">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h2 class="text-lg font-bold">Mã đơn hàng: @order.IdDh</h2>
                                        <p class="text-sm text-gray-500">
                                            Ngày đặt: @order.Ngaydathang?.ToString("dd/MM/yyyy hh:mm tt")
                                        </p>
                                        <p class="text-sm text-red-600 font-bold">
                                            Tổng tiền: @order.Tongtien.ToString("N0") VNĐ
                                        </p>
                                    </div>
                                    <div>
                                        @* Badge based on order status, matching the provided list *@
                                        @if(order.Trangthai == "Chờ xác nhận")
                                        {
                                            <span class="bg-yellow-100 text-yellow-700 text-sm font-medium px-3 py-1 rounded-full">Chờ xác nhận</span>
                                        }
                                        else if(order.Trangthai == "Đã thanh toán")
                                        {
                                            <span class="bg-green-100 text-green-500 text-sm font-medium px-3 py-1 rounded-full">Đã thanh toán</span>
                                        }
                                        else if(order.Trangthai == "Đặt hàng thành công")
                                        {
                                            <span class="bg-blue-100 text-blue-700 text-sm font-medium px-3 py-1 rounded-full">Đặt hàng thành công</span>
                                        }
                                        else if(order.Trangthai == "Đã duyệt đơn")
                                        {
                                            <span class="bg-indigo-100 text-indigo-700 text-sm font-medium px-3 py-1 rounded-full">Đã duyệt đơn</span>
                                        }
                                        else if(order.Trangthai == "Đang giao")
                                        {
                                            <span class="bg-green-100 text-green-700 text-sm font-medium px-3 py-1 rounded-full">Đang giao</span>
                                        }
                                        else if(order.Trangthai == "Giao thành công")
                                        {
                                            <span class="bg-blue-500 text-white text-sm font-medium px-3 py-1 rounded-full">Giao thành công</span>
                                        }
                                        else if(order.Trangthai == "Không giao")
                                        {
                                            <span class="bg-orange-100 text-orange-700 text-sm font-medium px-3 py-1 rounded-full">Không giao</span>
                                        }
                                        else if(order.Trangthai == "Hủy đơn")
                                        {
                                            <span class="bg-gray-100 text-gray-700 text-sm font-medium px-3 py-1 rounded-full">Hủy đơn</span>
                                        }
                                    </div>
                                </div>
                                <div class="flex space-x-3 mt-3">
                                    <!-- "Xem chi tiết" passes the order Id -->
                                    <a asp-action="OrderHistory" asp-route-orderId="@order.IdDh" class="bg-green-500 text-white px-4 py-2 rounded-md font-medium shadow hover:bg-green-600">
                                        Xem chi tiết
                                    </a>
                                </div>
                            </div>
                        }
                    }
                </div>
                <!-- Dynamic Pagination -->
                <div class="flex justify-between items-center mt-6">
                    @if(Model.HasPreviousPage)
                    {
                        <a asp-action="OrderHistory" asp-route-pageNumber="@(Model.PageNumber - 1)" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-md shadow hover:bg-gray-300">
                            ← Trước
                        </a>
                    }
                    else
                    {
                        <span class="bg-gray-200 text-gray-600 px-4 py-2 rounded-md shadow">← Trước</span>
                    }
                    <div class="space-x-2">
                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            if (i == Model.PageNumber)
                            {
                                <span class="bg-blue-500 text-white px-4 py-2 rounded-md shadow">@i</span>
                            }
                            else
                            {
                                <a asp-action="OrderHistory" asp-route-pageNumber="@i" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-md shadow hover:bg-gray-300">
                                    @i
                                </a>
                            }
                        }
                    </div>
                    @if(Model.HasNextPage)
                    {
                        <a asp-action="OrderHistory" asp-route-pageNumber="@(Model.PageNumber + 1)" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-md shadow hover:bg-gray-300">
                            Tiếp →
                        </a>
                    }
                    else
                    {
                        <span class="bg-gray-200 text-gray-600 px-4 py-2 rounded-md shadow">Tiếp →</span>
                    }
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Open the review modal
        document.getElementById('openReviewModal')?.addEventListener('click', function () {
            document.getElementById('reviewModal').classList.remove('hidden');
        });
        // Close the review modal
        document.getElementById('closeReviewModal')?.addEventListener('click', function () {
            document.getElementById('reviewModal').classList.add('hidden');
        });

        // AJAX submission for review form
        const reviewForm = document.getElementById('reviewForm');
        if (reviewForm) {
            reviewForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(reviewForm);
                fetch(reviewForm.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) {
                        // Redirect back to OrderHistory on success
                        window.location.href = '/ProfileManagement/OrderHistory';
                    }
                })
                .catch(error => {
                    alert("Có lỗi xảy ra khi gửi đánh giá.");
                    console.error(error);
                });
            });
        }

        // AJAX submission for cancel order form with confirmation
        const cancelForm = document.getElementById('cancelOrderForm');
        if (cancelForm) {
            cancelForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (confirm("Bạn có chắc chắn muốn hủy đơn hàng này?")) {
                    const formData = new FormData(cancelForm);
                    fetch(cancelForm.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        if (data.success) {
                            // Redirect back to OrderHistory on success
                            window.location.href = '/ProfileManagement/OrderHistory';
                        }
                    })
                    .catch(error => {
                        alert("Có lỗi xảy ra khi hủy đơn.");
                        console.error(error);
                    });
                }
            });
        }
    </script>
}
