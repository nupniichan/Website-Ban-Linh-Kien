@model Admin_WBLK.Models.Donhang

@{
    ViewData["Title"] = "Chỉnh sửa đơn hàng";
}

<div class="p-6 w-full h-full bg-gray-50">
    <div class="max-w-3xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">Chỉnh sửa đơn hàng</h1>

        <div class="bg-white rounded-lg shadow-sm p-6">
            <form asp-action="Edit" id="editOrderForm" onsubmit="return validateForm()">
                <div asp-validation-summary="ModelOnly" class="mb-4 p-4 rounded-lg bg-red-50 text-red-500"></div>
                <input type="hidden" asp-for="IdDh" />
                <input type="hidden" asp-for="Ngaydathang" />
                <input type="hidden" asp-for="Tongtien" />

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Mã đơn hàng (readonly) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mã đơn hàng</label>
                        <input value="@Model.IdDh" readonly class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg" />
                    </div>

                    <!-- Ngày đặt -->
                    <div>
                        <label asp-for="Ngaydathang" class="block text-sm font-medium text-gray-700 mb-1">Ngày đặt <span class="text-red-500">*</span></label>
                        <input asp-for="Ngaydathang" type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required />
                        <span asp-validation-for="Ngaydathang" class="text-red-500 text-sm mt-1"></span>
                        <span id="NgaydatError" class="text-red-500 text-sm mt-1"></span>
                    </div>

                    <!-- Mã khách hàng -->
                    <div>
                        <label asp-for="IdKh" class="block text-sm font-medium text-gray-700 mb-1">Mã khách hàng <span class="text-red-500">*</span></label>
                        <input asp-for="IdKh" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               required pattern="^KH[0-9]{5}$" title="Mã khách hàng phải bắt đầu bằng 'KH' và theo sau là 5 số" />
                        <span asp-validation-for="IdKh" class="text-red-500 text-sm mt-1"></span>
                        <span id="customerError" class="text-red-500 text-sm mt-1 hidden"></span>
                    </div>

                    <!-- Tên khách hàng (readonly) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tên khách hàng</label>
                        <input type="text" id="tenKhachHang" readonly class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg" />
                    </div>

                    <!-- Mã nhân viên -->
                    <div>
                        <label asp-for="IdNv" class="block text-sm font-medium text-gray-700 mb-1">Mã nhân viên <span class="text-red-500">*</span></label>
                        <input asp-for="IdNv" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               required pattern="^NV[0-9]{3}$" title="Mã nhân viên phải bắt đầu bằng 'NV' và theo sau là 3 số" />
                        <span asp-validation-for="IdNv" class="text-red-500 text-sm mt-1"></span>
                        <span id="staffError" class="text-red-500 text-sm mt-1 hidden"></span>
                    </div>

                    <!-- Tên nhân viên (readonly) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tên nhân viên</label>
                        <input type="text" id="tenNhanVien" readonly class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg" />
                    </div>

                    <!-- Trạng thái -->
                    <div>
                        <label asp-for="Trangthai" class="block text-sm font-medium text-gray-700 mb-1">Trạng thái</label>
                        <select asp-for="Trangthai" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="Chờ xác nhận">Chờ xác nhận</option>
                            <option value="Đã xác nhận">Đã xác nhận</option>
                            <option value="Đang giao">Đang giao</option>
                            <option value="Đã giao">Đã giao</option>
                            <option value="Đã hủy">Đã hủy</option>
                            <option value="Yêu cầu hủy">Yêu cầu hủy</option>
                        </select>
                        <span asp-validation-for="Trangthai" class="text-red-500 text-sm mt-1"></span>
                    </div>

                    <!-- Phương thức thanh toán -->
                    <div>
                        <label asp-for="Phuongthucthanhtoan" class="block text-sm font-medium text-gray-700 mb-1">Phương thức thanh toán</label>
                        <select asp-for="Phuongthucthanhtoan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="COD">Thanh toán khi nhận hàng (COD)</option>
                            <option value="Paypal">Paypal</option>
                            <option value="VNPay">Ví điện tử VNPay</option>
                        </select>
                        <span asp-validation-for="Phuongthucthanhtoan" class="text-red-500 text-sm mt-1"></span>
                    </div>

                    <!-- Mã giảm giá -->
                    <div>
                        <label asp-for="IdMgg" class="block text-sm font-medium text-gray-700 mb-1">Mã giảm giá</label>
                        <input asp-for="IdMgg" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                        <span asp-validation-for="IdMgg" class="text-red-500 text-sm mt-1"></span>
                    </div>

                    <!-- Địa chỉ giao hàng -->
                    <div class="md:col-span-2">
                        <label asp-for="Diachigiaohang" class="block text-sm font-medium text-gray-700 mb-1">Địa chỉ giao hàng</label>
                        <textarea asp-for="Diachigiaohang" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        <span asp-validation-for="Diachigiaohang" class="text-red-500 text-sm mt-1"></span>
                    </div>

                    <!-- Tổng tiền (readonly) -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tổng tiền</label>
                        <input value="@Model.Tongtien.ToString("#,##0 VNĐ")" readonly class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg" />
                    </div>
                </div>

                <!-- Thêm div hiển thị lỗi chung -->
                <div id="orderError" class="text-red-500 text-sm mt-4 mb-2 hidden"></div>

                <div class="flex justify-end gap-4 mt-6">
                    <a asp-action="Index" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-800">
                        Quay lại
                    </a>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        let isCustomerValid = true;
        let isStaffValid = true;

        // Kiểm tra khách hàng khi trang load
        window.addEventListener('load', async () => {
            await checkCustomer(document.getElementById('IdKh').value);
            await checkStaff(document.getElementById('IdNv').value);
        });

        // Validate khách hàng
        document.getElementById('IdKh').addEventListener('change', async function() {
            await checkCustomer(this.value);
        });

        // Validate nhân viên
        document.getElementById('IdNv').addEventListener('change', async function() {
            await checkStaff(this.value);
        });

        async function checkCustomer(customerId) {
            if (!customerId) {
                document.getElementById('tenKhachHang').value = '';
                return;
            }

            try {
                const response = await fetch(`/OrderManagement/GetCustomerInfo?id=${encodeURIComponent(customerId)}`);
                const data = await response.json();
                if (data) {
                    document.getElementById('tenKhachHang').value = data.hoten;
                    document.getElementById('customerError').classList.add('hidden');
                    isCustomerValid = true;
                } else {
                    document.getElementById('tenKhachHang').value = '';
                    document.getElementById('customerError').textContent = "Không tìm thấy khách hàng";
                    document.getElementById('customerError').classList.remove('hidden');
                    isCustomerValid = false;
                }
            } catch (error) {
                document.getElementById('customerError').textContent = "Lỗi khi kiểm tra thông tin khách hàng";
                document.getElementById('customerError').classList.remove('hidden');
                isCustomerValid = false;
            }
        }

        async function checkStaff(staffId) {
            if (!staffId) {
                document.getElementById('tenNhanVien').value = '';
                return;
            }

            try {
                const response = await fetch(`/OrderManagement/GetStaffInfo?id=${encodeURIComponent(staffId)}`);
                const data = await response.json();
                if (data) {
                    document.getElementById('tenNhanVien').value = data.hoten;
                    document.getElementById('staffError').classList.add('hidden');
                    isStaffValid = true;
                } else {
                    document.getElementById('tenNhanVien').value = '';
                    document.getElementById('staffError').textContent = "Không tìm thấy nhân viên";
                    document.getElementById('staffError').classList.remove('hidden');
                    isStaffValid = false;
                }
            } catch (error) {
                document.getElementById('staffError').textContent = "Lỗi khi kiểm tra thông tin nhân viên";
                document.getElementById('staffError').classList.remove('hidden');
                isStaffValid = false;
            }
        }

        function validateForm() {
            const errorMessages = [];
            
            if (!isCustomerValid) {
                errorMessages.push("Vui lòng chọn khách hàng hợp lệ");
                document.getElementById('customerError').textContent = "Khách hàng không hợp lệ";
                document.getElementById('customerError').classList.remove('hidden');
            }

            if (!isStaffValid) {
                errorMessages.push("Vui lòng chọn nhân viên hợp lệ");
                document.getElementById('staffError').textContent = "Nhân viên không hợp lệ";
                document.getElementById('staffError').classList.remove('hidden');
            }

            if (errorMessages.length > 0) {
                const orderError = document.getElementById('orderError');
                orderError.textContent = errorMessages.join(", ");
                orderError.classList.remove('hidden');
                return false;
            }

            return true;
        }
    </script>
} 